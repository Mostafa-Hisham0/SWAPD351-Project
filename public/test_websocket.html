<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Chat with Status</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            grid-column: 1 / -1;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .connected {
            background-color: #e6f7e6;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .disconnected {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 70vh;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.sent {
            background-color: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .message.received {
            background-color: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        .message.system {
            background-color: #fff8e1;
            text-align: center;
            margin: 15px auto;
            max-width: 90%;
            font-weight: 500;
            color: #5d4037;
        }
        .message .sender {
            font-weight: bold;
            font-size: 0.85em;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }
        .message .timestamp {
            font-size: 0.7em;
            color: #757575;
            margin-top: 5px;
            text-align: right;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        #messageInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        button {
            padding: 12px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3367d6;
        }
        button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        .users-panel {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
            height: 70vh;
            overflow-y: auto;
        }
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .users-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .user-item {
            padding: 10px;
            margin: 8px 0;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        .user-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-online {
            background-color: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        .status-offline {
            background-color: #f44336;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.3);
        }
        .status-idle {
            background-color: #ff9800;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.4);
        }
        .username {
            font-weight: 500;
        }
        .user-status {
            font-size: 0.8em;
            color: #616161;
        }
        .username-section {
            grid-column: 1 / -1;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .username-input {
            display: flex;
            gap: 10px;
        }
        #usernameInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        .empty-users {
            text-align: center;
            color: #757575;
            padding: 20px;
            font-style: italic;
        }
        .typing-indicator {
            font-size: 0.8em;
            color: #757575;
            margin-top: 5px;
            font-style: italic;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="status" class="status disconnected">Disconnected from server</div>
        
        <div class="username-section">
            <h2>Welcome to Real-Time Chat</h2>
            <p>Enter your name to join the chat</p>
            <div class="username-input">
                <input type="text" id="usernameInput" placeholder="Your name..." maxlength="20">
                <button id="setUsernameButton">Join Chat</button>
            </div>
        </div>

        <div class="chat-area">
            <div id="messages" class="messages"></div>
            <div class="typing-indicator" id="typingIndicator"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message..." disabled>
                <button id="sendButton" disabled>Send</button>
            </div>
        </div>

        <div class="users-panel">
            <div class="users-header">
                <h3>Online Users</h3>
                <span id="onlineCount">0</span>
            </div>
            <ul id="usersList" class="users-list">
                <li class="empty-users">No users connected</li>
            </ul>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            wsProtocol: window.location.protocol === 'https:' ? 'wss:' : 'ws:',
            wsHost: window.location.hostname,
            wsPort: window.location.port || '8080',
            heartbeatInterval: 5000, // 5 seconds - more frequent heartbeats
            statusUpdateInterval: 5000, // 5 seconds - more frequent status updates
            typingTimeout: 2000 // 2 seconds
        };
        
        const wsUrl = `${config.wsProtocol}//${config.wsHost}:${config.wsPort}/ws`;
        let ws = new WebSocket(wsUrl);
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // DOM Elements
        const elements = {
            status: document.getElementById('status'),
            messages: document.getElementById('messages'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            usersList: document.getElementById('usersList'),
            usernameInput: document.getElementById('usernameInput'),
            setUsernameButton: document.getElementById('setUsernameButton'),
            usernameSection: document.querySelector('.username-section'),
            onlineCount: document.getElementById('onlineCount'),
            typingIndicator: document.getElementById('typingIndicator')
        };

        // State
        const state = {
            userId: '',
            connectedUsers: new Set(),  // Currently connected users
            allUsers: new Set(),        // All users who have ever joined
            userStatuses: {},           // Status of all users
            typingUsers: new Set(),
            typingTimeout: null,
            connected: false
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            setupWebSocket();
            updateOnlineCount();
        }

        // Set up WebSocket connection and event handlers
        function setupWebSocket() {
            ws.onopen = handleWebSocketOpen;
            ws.onclose = handleWebSocketClose;
            ws.onerror = handleWebSocketError;
            ws.onmessage = handleWebSocketMessage;
        }

        // Handle WebSocket open event
        function handleWebSocketOpen() {
            console.log("WebSocket connection established");
            updateStatus('Connected to server', 'connected');
            enableUsernameInput();
            state.connected = true;
            reconnectAttempts = 0;
            
            // If user was already logged in, rejoin
            if (state.userId) {
                sendWebSocketMessage({
                    type: 'user_join',
                    userId: state.userId
                });
                
                // Request status update
                sendWebSocketMessage({
                    type: 'status_request'
                });
                
                // Start periodic status updates
                startStatusUpdates();
            }
        }

        // Handle WebSocket close event
        function handleWebSocketClose(event) {
            console.log("WebSocket connection closed", event);
            updateStatus('Disconnected from server', 'disconnected');
            disableChat();
            state.connected = false;
            
            // Try to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                console.log(`Attempting to reconnect in ${delay}ms (attempt ${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                
                setTimeout(() => {
                    reconnectAttempts++;
                    ws = new WebSocket(wsUrl);
                    setupWebSocket();
                }, delay);
            }
        }

        // Handle WebSocket error event
        function handleWebSocketError(error) {
            console.error('WebSocket error:', error);
            updateStatus('Connection error', 'disconnected');
        }

        // Handle WebSocket message event
        function handleWebSocketMessage(event) {
            try {
                const data = JSON.parse(event.data);
                console.log("Received message:", data);
                processIncomingMessage(data);
            } catch (e) {
                console.error('Error parsing message:', e);
                addSystemMessage(event.data);
            }
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Username setup
            elements.setUsernameButton.addEventListener('click', setUsername);
            elements.usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setUsername();
            });

            // Message sending
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Typing indicator
            elements.messageInput.addEventListener('input', handleTyping);

            // Window events
            window.addEventListener('beforeunload', handleBeforeUnload);
        }

        // Process different types of incoming messages
        function processIncomingMessage(data) {
            switch(data.type) {
                case 'user_list':
                    handleUserList(data);
                    break;
                case 'user_join':
                    handleUserJoin(data);
                    break;
                case 'user_leave':
                    handleUserLeave(data);
                    break;
                case 'status_change':
                    handleStatusChange(data);
                    break;
                case 'message':
                    handleChatMessage(data);
                    break;
                case 'typing':
                    handleTypingNotification(data);
                    break;
                case 'heartbeat':
                    // Silently handle heartbeat messages
                    break;
                default:
                    console.log("Unknown message type:", data.type);
                    addSystemMessage(JSON.stringify(data));
            }
        }

        // Handle user list updates
        function handleUserList(data) {
            console.log("Handling user list update:", data);
            
            if (data.users) {
                // Add all users to the allUsers set
                data.users.forEach(userId => {
                    state.allUsers.add(userId);
                });
                
                // Update connected users based on status
                state.connectedUsers = new Set();
                data.users.forEach(userId => {
                    if (data.statuses && data.statuses[userId] === 'online') {
                        state.connectedUsers.add(userId);
                    }
                });
            }
            
            if (data.statuses) {
                state.userStatuses = data.statuses;
            }
            
            updateUserList();
            updateOnlineCount();
        }

        // Handle user join notifications
        function handleUserJoin(data) {
            console.log("Handling user join:", data);
            if (data.userId) {
                state.allUsers.add(data.userId);
                state.connectedUsers.add(data.userId);
                
                if (data.status) {
                    state.userStatuses[data.userId] = data.status;
                } else {
                    state.userStatuses[data.userId] = "online"; // Default to online
                }
                
                updateUserList();
                updateOnlineCount();
                
                if (data.userId !== state.userId) {
                    addSystemMessage(`${data.userId} joined the chat`);
                }
            }
        }

        // Handle user leave notifications
        function handleUserLeave(data) {
            console.log("Handling user leave:", data);
            if (data.userId) {
                // Remove from connected users but keep in allUsers
                state.connectedUsers.delete(data.userId);
                
                if (data.status) {
                    state.userStatuses[data.userId] = data.status;
                } else {
                    state.userStatuses[data.userId] = "offline"; // Default to offline
                }
                
                updateUserList();
                updateOnlineCount();
                
                if (data.userId !== state.userId) {
                    addSystemMessage(`${data.userId} left the chat`);
                }
            }
        }

        // Handle status change notifications
        function handleStatusChange(data) {
            console.log("Handling status change:", data);
            if (data.userId && data.status) {
                state.userStatuses[data.userId] = data.status;
                
                // Update connected users set based on status
                if (data.status === 'online') {
                    state.connectedUsers.add(data.userId);
                } else {
                    state.connectedUsers.delete(data.userId);
                }
                
                updateUserList();
                updateOnlineCount();
                
                if (data.userId !== state.userId) {
                    addSystemMessage(`${data.userId} is now ${data.status}`);
                }
            }
        }

        // Handle chat messages
        function handleChatMessage(data) {
            if (data.text) {
                const sender = data.sender || "Unknown";
                const isCurrentUser = sender === state.userId;
                addChatMessage(data.text, sender, isCurrentUser);
                
                // Update sender status to online
                if (sender && !isCurrentUser) {
                    state.userStatuses[sender] = "online";
                    state.connectedUsers.add(sender);
                    state.allUsers.add(sender);
                    updateUserList();
                    updateOnlineCount();
                }
            }
        }

        // Handle typing notifications
        function handleTypingNotification(data) {
            if (data.userId && data.userId !== state.userId) {
                if (data.typing) {
                    state.typingUsers.add(data.userId);
                } else {
                    state.typingUsers.delete(data.userId);
                }
                updateTypingIndicator();
            }
        }

        // Set the username and join the chat
        function setUsername() {
            const username = elements.usernameInput.value.trim();
            if (username) {
                state.userId = username;
                elements.usernameSection.style.display = 'none';
                enableChat();
                
                // Send user join message
                sendWebSocketMessage({
                    type: 'user_join',
                    userId: state.userId,
                    status: 'online'
                });
                
                // Start periodic status updates
                startStatusUpdates();
                
                // Add system message
                addSystemMessage(`You joined as ${username}`);
            }
        }

        // Send a chat message
        function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (message && state.connected) {
                sendWebSocketMessage({
                    type: 'message',
                    text: message
                });
                elements.messageInput.value = '';
                
                // Notify that typing has stopped
                sendTypingStatus(false);
            }
        }

        // Handle typing events
        function handleTyping() {
            if (!state.typingTimeout) {
                sendTypingStatus(true);
            }
            
            clearTimeout(state.typingTimeout);
            state.typingTimeout = setTimeout(() => {
                sendTypingStatus(false);
                state.typingTimeout = null;
            }, config.typingTimeout);
        }

        // Send typing status notification
        function sendTypingStatus(typing) {
            if (state.connected && state.userId) {
                sendWebSocketMessage({
                    type: 'typing',
                    userId: state.userId,
                    typing: typing
                });
            }
        }

        // Update typing indicator
        function updateTypingIndicator() {
            if (state.typingUsers.size > 0) {
                const users = Array.from(state.typingUsers);
                let text = '';
                
                if (users.length === 1) {
                    text = `${users[0]} is typing...`;
                } else if (users.length === 2) {
                    text = `${users[0]} and ${users[1]} are typing...`;
                } else {
                    text = `${users[0]}, ${users[1]} and ${users.length - 2} others are typing...`;
                }
                
                elements.typingIndicator.textContent = text;
            } else {
                elements.typingIndicator.textContent = '';
            }
        }

        // Start periodic status updates
        function startStatusUpdates() {
            // Initial status request
            requestStatusUpdate();
            
            // Send heartbeat every 5 seconds
            const heartbeatInterval = setInterval(() => {
                if (state.connected && state.userId) {
                    console.log("Sending heartbeat");
                    sendWebSocketMessage({
                        type: 'heartbeat',
                        userId: state.userId
                    });
                }
                
                if (!state.connected) {
                    clearInterval(heartbeatInterval);
                }
            }, config.heartbeatInterval);
            
            // Request status update every 5 seconds
            const statusInterval = setInterval(() => {
                if (state.connected && state.userId) {
                    requestStatusUpdate();
                }
                
                if (!state.connected) {
                    clearInterval(statusInterval);
                }
            }, config.statusUpdateInterval);
        }

        // Request status update from server
        function requestStatusUpdate() {
            if (state.connected && state.userId) {
                console.log("Requesting status update");
                sendWebSocketMessage({
                    type: 'status_request'
                });
            }
        }

        // Send WebSocket message helper
        function sendWebSocketMessage(message) {
            if (state.connected && ws.readyState === WebSocket.OPEN) {
                // Add userId to all messages if available
                if (state.userId && !message.userId) {
                    message.userId = state.userId;
                }
                console.log("Sending message:", message);
                ws.send(JSON.stringify(message));
                return true;
            } else {
                console.warn("Cannot send message, WebSocket not connected");
                return false;
            }
        }

        // Add a chat message to the UI
        function addChatMessage(text, sender, isCurrentUser) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            
            const senderElement = document.createElement('span');
            senderElement.className = 'sender';
            senderElement.textContent = isCurrentUser ? 'You' : sender;
            messageElement.appendChild(senderElement);
            
            const textElement = document.createElement('div');
            textElement.textContent = text;
            messageElement.appendChild(textElement);

            const timestampElement = document.createElement('div');
            timestampElement.className = 'timestamp';
            timestampElement.textContent = formatTimestamp();
            messageElement.appendChild(timestampElement);
            
            elements.messages.appendChild(messageElement);
            scrollToBottom();
        }

        // Add a system message to the UI
        function addSystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.textContent = text;
            
            const timestampElement = document.createElement('div');
            timestampElement.className = 'timestamp';
            timestampElement.textContent = formatTimestamp();
            messageElement.appendChild(timestampElement);
            
            elements.messages.appendChild(messageElement);
            scrollToBottom();
        }

        // Update the user list UI
        function updateUserList() {
            console.log("Updating user list with statuses:", state.userStatuses);
            elements.usersList.innerHTML = '';
            
            if (state.allUsers.size === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'empty-users';
                emptyItem.textContent = 'No users connected';
                elements.usersList.appendChild(emptyItem);
                return;
            }

            // Sort users: online first, then alphabetically
            const sortedUsers = Array.from(state.allUsers).sort((a, b) => {
                const statusA = state.userStatuses[a] || 'offline';
                const statusB = state.userStatuses[b] || 'offline';
                
                // Online users first
                if (statusA === 'online' && statusB !== 'online') return -1;
                if (statusA !== 'online' && statusB === 'online') return 1;
                
                // Then current user
                if (a === state.userId) return -1;
                if (b === state.userId) return 1;
                
                // Then alphabetically
                return a.localeCompare(b);
            });

            sortedUsers.forEach(userId => {
                const userItem = document.createElement('li');
                userItem.className = 'user-item';
                
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                
                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'status-indicator';
                
                // Get user status (default to offline)
                const status = state.userStatuses[userId] || 'offline';
                statusIndicator.classList.add(`status-${status}`);
                
                const username = document.createElement('span');
                username.className = 'username';
                username.textContent = userId === state.userId ? 'You' : userId;
                
                userInfo.appendChild(statusIndicator);
                userInfo.appendChild(username);
                
                const statusText = document.createElement('span');
                statusText.className = 'user-status';
                statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                userItem.appendChild(userInfo);
                userItem.appendChild(statusText);
                elements.usersList.appendChild(userItem);
            });
        }

        // Update online users count
        function updateOnlineCount() {
            const onlineCount = Array.from(state.allUsers).filter(
                userId => state.userStatuses[userId] === 'online'
            ).length;
            
            elements.onlineCount.textContent = `${onlineCount} ${onlineCount === 1 ? 'user' : 'users'} online`;
        }

        // Update connection status UI
        function updateStatus(text, status) {
            elements.status.textContent = text;
            elements.status.className = `status ${status}`;
        }

        // Enable username input
        function enableUsernameInput() {
            elements.usernameInput.disabled = false;
            elements.setUsernameButton.disabled = false;
        }

        // Disable username input
        function disableUsernameInput() {
            elements.usernameInput.disabled = true;
            elements.setUsernameButton.disabled = true;
        }

        // Enable chat functionality
        function enableChat() {
            elements.messageInput.disabled = false;
            elements.sendButton.disabled = false;
            elements.messageInput.focus();
        }

        // Disable chat functionality
        function disableChat() {
            elements.messageInput.disabled = true;
            elements.sendButton.disabled = true;
        }

        // Format timestamp
        function formatTimestamp() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Scroll messages to bottom
        function scrollToBottom() {
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }

        // Handle beforeunload event
        function handleBeforeUnload() {
            if (state.connected && state.userId) {
                sendWebSocketMessage({
                    type: 'user_leave',
                    userId: state.userId
                });
            }
        }

        // Initialize the application
        init();
    </script>
</body>
</html>